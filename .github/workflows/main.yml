name: Test & static analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  qa:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        task: [analyze, lint, test]

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4.8"
          tools: composer:v2
          coverage: none
          ini-values: memory_limit=-1

      - uses: ramsey/composer-install@v3
        with:
          dependency-versions: locked
          composer-options: "--optimize-autoloader"

      - run: composer ${{ matrix.task }}

  create-project-test:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4.8"
          tools: composer:v2
          coverage: none
          ini-values: memory_limit=-1

      - name: Create project from template
        run: |
          cd /tmp
          composer create-project sanderdlm/skeleton test-project \
            --repository='{"type":"path","url":"${{ github.workspace }}","options":{"symlink":false}}' \
            --stability=dev \
            --no-interaction

      - name: Setup environment
        run: |
          cd /tmp/test-project
          cp .env.example .env

      - name: Start built-in webserver
        run: |
          cd /tmp/test-project
          php -S localhost:8080 -t public/ &
          # Wait for server to be ready
          server_ready=false
          for i in {1..10}; do
            if curl -s http://localhost:8080/ > /dev/null; then
              echo "âœ… Server is ready"
              server_ready=true
              break
            fi
            echo "Waiting for server... (attempt $i/10)"
            sleep 1
          done
          # Fail if server never became ready
          if [ "$server_ready" = "false" ]; then
            echo "âŒ Server failed to start after 10 attempts"
            exit 1
          fi

      - name: Test homepage
        run: |
          response=$(curl -s http://localhost:8080/)
          echo "Response content:"
          echo "$response"
          if echo "$response" | grep -q "ğŸ¤–"; then
            echo "âœ… Homepage contains expected content"
          else
            echo "âŒ Homepage does not contain expected content"
            exit 1
          fi
